<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Accelerometer Spin Counter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    
    <style>
        /* Custom CSS embedded directly into the HTML file */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
            color: white;
            /* Prevent pull-to-refresh on mobile */
            overscroll-behavior-y: contain;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            color: white;
            transition: background-color 0.3s, transform 0.2s;
            border: none;
            cursor: pointer;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        /* Spin detection animation */
        .spin-detected {
            animation: pulse-bright 0.6s ease-out;
        }

        @keyframes pulse-bright {
            0% {
                transform: scale(1);
                text-shadow: 0 0 5px rgba(255, 255, 255, 0);
            }
            50% {
                transform: scale(1.15);
                text-shadow: 0 0 20px rgba(34, 211, 238, 0.9); /* cyan-400 glow */
            }
            100% {
                transform: scale(1);
                text-shadow: 0 0 5px rgba(255, 255, 255, 0);
            }
        }

        #spin-gallery .spin-card {
            background-color: #1f2937; /* bg-gray-800 */
            border-radius: 0.5rem;
            padding: 0.75rem;
            text-align: center;
            border: 1px solid #374151; /* border-gray-700 */
        }

        #spin-gallery .spin-card canvas {
            width: 100%;
            height: auto;
            border-radius: 0.25rem;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body class="antialiased">

    <div id="app" class="container mx-auto p-4 max-w-lg">
        <header class="text-center my-4">
            <h1 class="text-4xl font-bold text-cyan-400">Spin Counter</h1>
            <p id="instructions" class="text-gray-400 mt-2 px-4">Press 'Start' and spin your phone to see the magic!</p>
        </header>

        <div id="spinCounters" class="grid grid-cols-3 gap-4 text-center my-8">
            <div>
                <h2 class="text-lg font-semibold text-gray-400">Yaw (Z)</h2>
                <p id="yawCount" class="text-5xl font-bold text-white transition-transform duration-200">0</p>
            </div>
            <div>
                <h2 class="text-lg font-semibold text-gray-400">Pitch (X)</h2>
                <p id="pitchCount" class="text-5xl font-bold text-white transition-transform duration-200">0</p>
            </div>
            <div>
                <h2 class="text-lg font-semibold text-gray-400">Roll (Y)</h2>
                <p id="rollCount" class="text-5xl font-bold text-white transition-transform duration-200">0</p>
            </div>
        </div>

        <div id="graphsContainer" class="my-6 space-y-4">
            <div>
                <label for="yawCanvas" class="text-gray-400">Yaw (Z-axis)</label>
                <canvas id="yawCanvas" class="w-full h-24 bg-gray-800 rounded-lg"></canvas>
            </div>
            <div>
                <label for="pitchCanvas" class="text-gray-400">Pitch (X-axis)</label>
                <canvas id="pitchCanvas" class="w-full h-24 bg-gray-800 rounded-lg"></canvas>
            </div>
            <div>
                <label for="rollCanvas" class="text-gray-400">Roll (Y-axis)</label>
                <canvas id="rollCanvas" class="w-full h-24 bg-gray-800 rounded-lg"></canvas>
            </div>
        </div>
        
        <div id="controls" class="flex justify-center gap-4 my-6">
            <button id="startBtn" class="btn bg-green-500 hover:bg-green-600">Start Monitoring</button>
            <button id="stopBtn" class="btn bg-red-500 hover:bg-red-600 hidden">Stop Monitoring</button>
        </div>

        <div id="results" class="hidden">
            <div id="capturedSpinsContainer" class="my-6">
                <h3 class="text-2xl font-bold text-center text-cyan-400 mb-4">Captured Spins</h3>
                <div id="spin-gallery" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>
            </div>
            <div class="text-center">
                <button id="shareBtn" class="btn bg-blue-500 hover:bg-blue-600">Share Results</button>
            </div>
        </div>

    </div>

    <script>
        // JavaScript logic embedded directly into the HTML file
        document.addEventListener('DOMContentLoaded', () => {
            const startBtn = document.getElementById('startBtn');
            const stopBtn = document.getElementById('stopBtn');
            const shareBtn = document.getElementById('shareBtn');
            
            const yawCountEl = document.getElementById('yawCount');
            const pitchCountEl = document.getElementById('pitchCount');
            const rollCountEl = document.getElementById('rollCount');

            const canvases = {
                yaw: document.getElementById('yawCanvas'),
                pitch: document.getElementById('pitchCanvas'),
                roll: document.getElementById('rollCanvas'),
            };

            const contexts = {
                yaw: canvases.yaw.getContext('2d'),
                pitch: canvases.pitch.getContext('2d'),
                roll: canvases.roll.getContext('2d'),
            };

            const capturedSpinsContainer = document.getElementById('spin-gallery');
            const resultsSection = document.getElementById('results');

            let monitoring = false;
            let counts = { yaw: 0, pitch: 0, roll: 0 };
            let lastAngles = { yaw: null, pitch: null, roll: null };
            let history = { yaw: [], pitch: [], roll: [] };
            const historyLength = 100;

            const setupCanvas = (canvas, context) => {
                const dpr = window.devicePixelRatio || 1;
                const rect = canvas.getBoundingClientRect();
                canvas.width = rect.width * dpr;
                canvas.height = rect.height * dpr;
                context.scale(dpr, dpr);
                context.lineWidth = 2;
                context.strokeStyle = '#22d3ee'; // cyan-400
            };

            Object.values(canvases).forEach((canvas, index) => {
                setupCanvas(canvas, Object.values(contexts)[index]);
            });
            
            const resetState = () => {
                monitoring = false;
                counts = { yaw: 0, pitch: 0, roll: 0 };
                lastAngles = { yaw: null, pitch: null, roll: null };
                history = { yaw: [], pitch: [], roll: [] };
                
                yawCountEl.textContent = '0';
                pitchCountEl.textContent = '0';
                rollCountEl.textContent = '0';

                Object.values(contexts).forEach(ctx => {
                    const canvas = ctx.canvas;
                    const rect = canvas.getBoundingClientRect();
                    ctx.clearRect(0, 0, rect.width, rect.height);
                });
                
                capturedSpinsContainer.innerHTML = '';
                resultsSection.classList.add('hidden');
                stopBtn.classList.add('hidden');
                startBtn.classList.remove('hidden');
            };

            const handleOrientation = (event) => {
                if (!monitoring) return;

                // Normalize angles to be non-null
                const alpha = event.alpha || 0; // Yaw
                const beta = event.beta || 0;   // Pitch
                const gamma = event.gamma || 0; // Roll
                
                updateLiveGraph('yaw', alpha, 360);
                updateLiveGraph('pitch', beta, 180);
                updateLiveGraph('roll', gamma, 180); // Roll range is -90 to 90, so total 180

                detectSpin('yaw', alpha, 360, yawCountEl);
                detectSpin('pitch', beta, 180, pitchCountEl);
                detectSpin('roll', gamma, 180, rollCountEl);
            };

            const detectSpin = (axis, currentValue, range, element) => {
                if (lastAngles[axis] === null) {
                    lastAngles[axis] = currentValue;
                    return;
                }

                const diff = Math.abs(currentValue - lastAngles[axis]);

                // Detect a spin when the value wraps around the range
                // e.g., for Yaw (0-360), a jump from 350 to 10 is a spin
                if (diff > range * 0.8) { 
                    counts[axis]++;
                    element.textContent = counts[axis];
                    element.classList.add('spin-detected');
                    setTimeout(() => element.classList.remove('spin-detected'), 600);
                    
                    // Capture the spin data and celebrate milestones
                    captureSpin(axis, [...history[axis]]); // Pass a copy of the history
                    const totalSpins = counts.yaw + counts.pitch + counts.roll;
                    if (totalSpins > 0 && totalSpins % 5 === 0) {
                        triggerConfetti();
                    }
                }
                lastAngles[axis] = currentValue;
            };
            
            const updateLiveGraph = (axis, value, maxRange) => {
                const data = history[axis];
                data.push(value);
                if (data.length > historyLength) {
                    data.shift();
                }

                const context = contexts[axis];
                const canvas = canvases[axis];
                const { width, height } = canvas.getBoundingClientRect();
                
                context.clearRect(0, 0, width, height);
                context.beginPath();
                
                data.forEach((point, i) => {
                    // Normalize point based on axis range
                    let normalizedPoint = point;
                    if (axis === 'pitch') normalizedPoint += 90; // Shift -90 to 90 range to 0 to 180
                    if (axis === 'roll') normalizedPoint += 90; // Shift -90 to 90 range to 0 to 180
                    
                    const x = (i / (historyLength - 1)) * width;
                    const y = height - ((normalizedPoint / maxRange) * height);

                    if (i === 0) {
                        context.moveTo(x, y);
                    } else {
                        context.lineTo(x, y);
                    }
                });
                context.stroke();
            };

            const captureSpin = (axis, data) => {
                const card = document.createElement('div');
                card.className = 'spin-card';
                
                const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                card.innerHTML = `
                    <p class="font-semibold text-cyan-400">${axis.charAt(0).toUpperCase() + axis.slice(1)} Spin #${counts[axis]}</p>
                    <p class="text-xs text-gray-500">${timestamp}</p>
                `;

                const canvas = document.createElement('canvas');
                card.appendChild(canvas);
                capturedSpinsContainer.appendChild(card);
                
                drawCapturedGraph(canvas, data, axis);
            };

            const drawCapturedGraph = (canvas, data, axis) => {
                const context = canvas.getContext('2d');
                setupCanvas(canvas, context);
                context.strokeStyle = '#a78bfa'; // violet-400

                const { width, height } = canvas.getBoundingClientRect();
                context.clearRect(0, 0, width, height);
                context.beginPath();

                let maxRange = 360;
                if (axis === 'pitch' || axis === 'roll') maxRange = 180;

                data.forEach((point, i) => {
                    let normalizedPoint = point;
                    if (axis === 'pitch' || axis === 'roll') normalizedPoint += 90;
                    
                    const x = (i / (data.length - 1)) * width;
                    const y = height - ((normalizedPoint / maxRange) * height);

                    if (i === 0) {
                        context.moveTo(x, y);
                    } else {
                        context.lineTo(x, y);
                    }
                });
                context.stroke();
            };

            const triggerConfetti = () => {
                if (window.confetti) {
                    confetti({
                        particleCount: 150,
                        spread: 90,
                        origin: { y: 0.6 }
                    });
                }
            };
            
            const startMonitoring = () => {
                resetState();
                monitoring = true;
                startBtn.classList.add('hidden');
                stopBtn.classList.remove('hidden');
                document.getElementById('instructions').textContent = "Spin away! Let's see what you've got.";
                window.addEventListener('deviceorientation', handleOrientation);
            };

            startBtn.addEventListener('click', () => {
                // Request permission for iOS 13+ devices
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    DeviceOrientationEvent.requestPermission()
                        .then(permissionState => {
                            if (permissionState === 'granted') {
                                startMonitoring();
                            } else {
                                alert('Permission to access device orientation was denied.');
                            }
                        })
                        .catch(console.error);
                } else {
                    // Handle non-iOS 13+ devices
                    startMonitoring();
                }
            });

            stopBtn.addEventListener('click', () => {
                monitoring = false;
                window.removeEventListener('deviceorientation', handleOrientation);
                stopBtn.classList.add('hidden');
                startBtn.classList.remove('hidden');
                
                const totalSpins = counts.yaw + counts.pitch + counts.roll;
                if (totalSpins > 0) {
                    resultsSection.classList.remove('hidden');
                }
                document.getElementById('instructions').textContent = "Great job! Press 'Start' to go again.";
            });
            
            shareBtn.addEventListener('click', () => {
                const totalSpins = counts.yaw + counts.pitch + counts.roll;
                const shareData = {
                    title: 'Spin Counter Results',
                    text: `I just did ${totalSpins} total spins! (Yaw: ${counts.yaw}, Pitch: ${counts.pitch}, Roll: ${counts.roll}). Can you beat me?`,
                    url: window.location.href
                };

                if (navigator.share) {
                    navigator.share(shareData).catch(console.error);
                } else {
                    // Fallback for desktop or unsupported browsers
                    alert('Share functionality is not supported on this browser. Try on a mobile device!');
                }
            });

            // Initial state setup
            resetState();
        });
    </script>
</body>
</html>
